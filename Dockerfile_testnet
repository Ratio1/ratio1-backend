###################
# Builder stage   #
###################
#FROM golang:1.21-alpine AS builder
FROM golang:1.21 AS builder

ARG VERSION

WORKDIR /src

# Grab deps first for better cache
COPY go.mod go.sum ./

RUN go get github.com/ethereum/go-ethereum@v1.14.5

RUN go mod download

COPY . .
RUN go build -ldflags="-X 'github.com/NaeuralEdgeProtocol/ratio1-backend/config.BackendVersion=${VERSION}'" -o backend ./cmd
#RUN CGO_ENABLED=0 \
#    go build -trimpath \
#      -ldflags "-s -w \
#        -X 'github.com/NaeuralEdgeProtocol/ratio1-backend/config.BackendVersion=${VERSION}'" \
#      -o /ratio1-backend ./cmd
#RUN CGO_ENABLED=0 \
#    go build -trimpath \
#      -ldflags "-s -w \
#        -X 'github.com/NaeuralEdgeProtocol/ratio1-backend/config.BackendVersion=${VERSION}'" \
#      -o /ratio1-backend ./cmd

RUN ls /
RUN ls /src
RUN ls /src/cmd


###################
# Runtime image   #
###################
FROM gcr.io/distroless/static:nonroot
ARG VERSION

LABEL org.opencontainers.image.version=$VERSION
COPY templates/html /templates/html
COPY config         /config
COPY cmd            /cmd
COPY --from=builder /src/backend /cmd/ratio1-backend


USER nonroot
ENTRYPOINT ["./cmd/ratio1-backend"]
